# Pis House Control Server ドキュメント

本ドキュメントは、スマートホーム制御サーバー `pis-house-control-server` に関する情報を、「利用者向け」と「開発者向け」に分けて記述したものです。

---

## 🟢 1. 利用者向けガイド (User Guide)

このセクションでは、居住者やシステム利用者が知っておくべき「このシステムで何ができるか」「利用上の注意」について説明します。

### 1.1 システムの概要（これって何？）
**pis-house-control-server** は、あなたの家（Pis House）の「司令塔」として働くプログラムです。
Raspberry Pi などの小型コンピュータの中で 24時間365日 動き続け、あなたのスマホと、家の中の家電（エアコンや照明）をつなぐ役割を果たしています。

### 1.2 主な機能（何ができるの？）

このシステムが動いているおかげで、以下の便利な機能が利用できます。

1.  **スマホで家電をリモコン操作**
    * 外出先からスマホアプリで「エアコン ON」にすると、この司令塔が指示を受け取り、家にあるコントローラーを通じてエアコンをつけます。
2.  **「ただいま」の自動検知と通知**
    * 家族が持っているスマホ（BLEビーコン）を検知し、「誰かが外出した」「誰かが帰宅した」といった情報を判断します。
    * 帰宅時に「〇〇さんが帰宅しました」とスマホに通知を送ることができます。
3.  **近づくだけでスイッチON（自動化）**
    * あなたが特定のデバイスに近づいたこと（電波強度が強くなったこと）を検知すると、スマホを操作しなくても自動で照明などを ON にします。

### 1.3 利用上の注意

* **電源を切らないでください**
    * このプログラムが動いている Raspberry Pi の電源を切ると、スマホからの操作や自動通知がすべて停止します。常に電源を入れたままにしてください。
* **Wi-Fi 環境が必要です**
    * 家の Wi-Fi ルーターを経由して通信しています。ルーターの電源が切れていたり、Wi-Fi の設定が変わると動作しません。

---

## 🔵 2. 開発者向けドキュメント (Developer Documentation)

このセクションでは、エンジニアや保守担当者向けに、システムのアーキテクチャ、技術スタック、モジュール構成について詳述します。

### 2.1 システムスペック

| 項目 | 内容 |
| :--- | :--- |
| **システム名** | pis-house-control-server |
| **プラットフォーム** | Linux (Raspberry Pi OS 推奨) |
| **言語** | Python 3.x |
| **通信プロトコル** | HTTPS (Firestore), UDP (Local Network) |
| **アーキテクチャ** | イベント駆動型 (Producer-Consumer パターン) |

### 2.2 システムの目的と範囲

本システムは、**クラウド（Firebase）とローカル IoT デバイス（ESP32）間のブリッジ**として機能します。

* **担当範囲 (In-Scope)**:
    * サーバーサイドの常駐プロセス処理。
    * Firestore の変更検知（リアルタイムリスナー）およびデータ更新。
    * ESP32 との UDP パケット送受信。
    * センサーデータ（RSSI, BLE）に基づく自動化ロジックの実行。
* **範囲外 (Out-of-Scope)**:
    * ユーザーインターフェース（スマホアプリ `pis-house-frontend` が担当）。
    * デバイスの初期プロビジョニング（設定ツール `pis-house-setup` が担当）。
    * ESP32 内のファームウェアロジック。

### 2.3 アーキテクチャ設計

本システムは、**マルチスレッド** および **Queue を介した Producer-Consumer パターン** を採用しており、非同期イベントを効率的に処理します。

#### データフローとスレッド構成

1.  **Producer (入力ソース)**
    * **`FirebaseReceiver` (Thread)**: Firestore を監視し、クラウドからの操作指示を受信して Queue に積む。
    * **`UdpServer` (Thread)**: UDP ポート 9000 で待機し、ESP32 からのセンサーデータ（RSSI, BLE）を受信して Queue に積む。
2.  **Queue (バッファ)**
    * **`Task Queue`**: イベント（`TaskEvent`）を一時的に保持し、処理の平準化を行う。
3.  **Consumer (処理実行)**
    * **`Main Loop`**: Queue からイベントを取り出し、以下の処理を実行する。
        * **`UdpClient`** を使用した赤外線コマンドの送信。
        * Firestore のステータス更新。
        * 通知データの作成。
4.  **Shared Memory**
    * **`ip_to_share_data`**: デバイスの最新状態を保持するインメモリデータベース（`threading.Lock` で排他制御）。

### 2.4 モジュール詳細

| ファイル名 | 役割・機能 |
| :--- | :--- |
| **`main.py`** | エントリーポイント。スレッド起動、メインループ（Consumer）、在宅判定ロジック。 |
| **`firebase_receiver.py`** | クラウド監視スレッド。Firestore の `setup/{UUID}/devices` をリスンする。 |
| **`udp_server.py`** | ローカル受信スレッド。RSSI閾値判定（60以下でActive化）や BLE プレゼンス解析を行う。 |
| **`udp_client.py`** | UDP 送信クライアント。赤外線コマンドを ESP32 へ送信する。 |
| **`share_data.py`** | 共有データモデル（`ShareData`, `InfraredData`）の定義。 |
| **`task_event.py`** | イベント種別定義（`SEND_ESP32_DEVICE_TOGGLE` 等）。 |
| **`message_format.py`** | UDP メッセージのシリアライズ/デシリアライズ。 |
| **`network_config_info.py`** | ホストマシンの IP 自動取得ユーティリティ。 |

### 2.5 自動化ロジックの仕様

1.  **近接オートメーション (RSSI)**
    * `udp_server.py` にて RSSI 値を監視。
    * **閾値**: RSSI <= 60（強い電波＝近接）
    * **動作**: 閾値を下回った場合、即座に対象デバイスのステータスを `Active` に変更し、ON 信号を送信する。
2.  **在宅/外出通知**
    * 管理下の全デバイスの `is_ble_presence` を集計。
    * **判定**: 「誰もいない(False)」⇔「誰かいる(True)」の状態遷移が発生した瞬間に通知イベントを発火。
    * **出力**: Firestore の `notifications` コレクションに書き込みを行う。